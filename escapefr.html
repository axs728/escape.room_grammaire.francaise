<!doctype html>
<html lang="fr">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>French Grammar Escape Room</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Georgia', serif;
      background: #1a1a2e;
      color: #eee;
      height: 100%;
      overflow: hidden;
    }
    
    html {
      height: 100%;
    }
    
    * {
      box-sizing: border-box;
    }
    
    #app {
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    
    .screen {
      display: none;
      animation: fadeIn 0.5s;
      height: 100%;
    }
    
    .screen.active {
      display: flex;
      flex-direction: column;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .welcome-screen {
      text-align: center;
      max-width: 600px;
      margin: auto;
      padding: 40px 20px;
    }
    
    .welcome-screen h1 {
      font-size: 48px;
      color: #f39c12;
      margin-bottom: 20px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .welcome-screen p {
      font-size: 18px;
      margin-bottom: 30px;
      line-height: 1.6;
    }
    
    .name-input {
      width: 100%;
      padding: 15px;
      font-size: 18px;
      border: 2px solid #f39c12;
      border-radius: 8px;
      margin-bottom: 20px;
      background: #16213e;
      color: #eee;
    }
    
    .btn {
      padding: 15px 40px;
      font-size: 18px;
      background: #f39c12;
      color: #1a1a2e;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .btn:hover {
      background: #e67e22;
      transform: scale(1.05);
    }
    
    .btn:disabled {
      background: #555;
      cursor: not-allowed;
      transform: none;
    }

    /* Escape Room Visual */
    .room-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 15px;
      overflow-y: auto;
    }
    
    .room-header {
      text-align: center;
      margin-bottom: 15px;
      flex-shrink: 0;
    }
    
    .room-title {
      font-size: 28px;
      color: #f39c12;
      margin-bottom: 8px;
    }

    .room-description {
      font-size: 14px;
      color: #bbb;
      margin-bottom: 10px;
      font-style: italic;
    }
    
    .progress-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      margin-bottom: 10px;
    }

    .clues-found {
      font-size: 16px;
      color: #f39c12;
      font-weight: bold;
    }

    .timer {
      font-size: 16px;
      color: #eee;
    }

    .room-visual {
      position: relative;
      background: linear-gradient(180deg, #2d3561 0%, #1a1a2e 100%);
      border: 3px solid #0f3460;
      border-radius: 12px;
      min-height: 400px;
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .room-scene {
      position: relative;
      flex: 1;
      padding: 20px;
    }

    .room-object {
      position: absolute;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    .room-object:hover {
      transform: scale(1.1);
      filter: brightness(1.3);
    }

    .room-object.completed {
      opacity: 0.5;
      filter: grayscale(0.7);
    }

    .room-object.completed::after {
      content: '‚úì';
      position: absolute;
      top: -10px;
      right: -10px;
      background: #27ae60;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: bold;
    }

    .object-icon {
      font-size: 48px;
      display: block;
      margin-bottom: 5px;
      filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));
    }

    .object-label {
      font-size: 12px;
      background: rgba(0,0,0,0.7);
      padding: 4px 8px;
      border-radius: 4px;
      white-space: nowrap;
    }

    /* Modal for activities */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      animation: fadeIn 0.3s;
      overflow-y: auto;
    }

    .modal-overlay.active {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-content {
      background: #16213e;
      padding: 30px;
      border-radius: 12px;
      max-width: 700px;
      width: 100%;
      max-height: 90%;
      overflow-y: auto;
      border: 3px solid #f39c12;
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 28px;
      cursor: pointer;
      color: #f39c12;
      background: none;
      border: none;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s;
    }

    .modal-close:hover {
      background: #f39c12;
      color: #1a1a2e;
    }

    .activity-title {
      font-size: 24px;
      color: #f39c12;
      margin-bottom: 20px;
      padding-right: 40px;
    }

    .question-text {
      font-size: 18px;
      margin-bottom: 20px;
      line-height: 1.6;
    }
    
    .options {
      display: grid;
      gap: 12px;
      margin: 20px 0;
    }
    
    .option {
      padding: 15px;
      background: #0f3460;
      border: 2px solid #16213e;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 16px;
    }
    
    .option:hover {
      border-color: #f39c12;
      transform: translateX(5px);
    }
    
    .option.selected {
      border-color: #f39c12;
      background: #1a4d7a;
    }
    
    .drag-drop-area {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin: 20px 0;
    }
    
    .drop-zone {
      min-height: 80px;
      padding: 12px;
      background: #0f3460;
      border: 2px dashed #f39c12;
      border-radius: 8px;
      flex: 1;
      min-width: 150px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .drop-zone-label {
      font-weight: bold;
      color: #f39c12;
      font-size: 14px;
      margin-bottom: 5px;
    }
    
    .draggable {
      padding: 10px 15px;
      background: #f39c12;
      color: #1a1a2e;
      border-radius: 6px;
      cursor: move;
      user-select: none;
      display: inline-block;
      margin: 4px;
      font-weight: bold;
      font-size: 14px;
    }
    
    .draggable.dragging {
      opacity: 0.5;
    }
    
    .draggables-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 15px;
      background: #0f3460;
      border-radius: 8px;
      margin-bottom: 20px;
      min-height: 60px;
    }
    
    .hidden-clue {
      position: relative;
      padding: 15px;
      background: #0f3460;
      border-radius: 8px;
      margin: 15px 0;
      cursor: pointer;
      border: 2px solid #555;
      transition: all 0.3s;
    }
    
    .hidden-clue:hover {
      border-color: #f39c12;
    }
    
    .clue-hint {
      color: #f39c12;
      font-style: italic;
      font-size: 14px;
    }
    
    .clue-content {
      display: none;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #555;
      animation: fadeIn 0.3s;
    }
    
    .clue-content.revealed {
      display: block;
    }
    
    .clickable-element {
      display: inline-block;
      padding: 10px 15px;
      background: #0f3460;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
      transition: all 0.3s;
      border: 2px solid transparent;
      font-size: 15px;
    }
    
    .clickable-element:hover {
      border-color: #f39c12;
    }
    
    .clickable-element.clicked {
      background: #f39c12;
      color: #1a1a2e;
    }
    
    .feedback {
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      font-weight: bold;
      display: none;
    }
    
    .feedback.show {
      display: block;
      animation: fadeIn 0.3s;
    }
    
    .feedback.correct {
      background: #27ae60;
      color: white;
    }
    
    .feedback.incorrect {
      background: #e74c3c;
      color: white;
    }
    
    .submit-btn {
      width: 100%;
      margin-top: 20px;
    }

    /* Code panel */
    .code-panel {
      background: #0f3460;
      padding: 15px;
      border-top: 2px solid #f39c12;
      text-align: center;
    }

    .code-display {
      font-size: 24px;
      font-weight: bold;
      color: #f39c12;
      letter-spacing: 8px;
      font-family: 'Courier New', monospace;
    }

    .code-label {
      font-size: 12px;
      color: #bbb;
      margin-bottom: 5px;
    }

    .unlock-btn {
      margin-top: 15px;
      padding: 12px 30px;
      font-size: 16px;
      background: #27ae60;
      animation: pulse 2s infinite;
    }

    .unlock-btn:hover {
      background: #229954;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }
    
    .completion-screen {
      text-align: center;
      max-width: 600px;
      margin: auto;
      padding: 40px 20px;
    }
    
    .completion-screen h2 {
      font-size: 42px;
      color: #27ae60;
      margin-bottom: 20px;
    }
    
    .score-display {
      font-size: 32px;
      color: #f39c12;
      margin: 30px 0;
    }
    
    .leaderboard {
      background: #16213e;
      padding: 20px;
      border-radius: 12px;
      margin-top: 30px;
    }
    
    .leaderboard h3 {
      color: #f39c12;
      margin-bottom: 15px;
    }
    
    .leaderboard-entry {
      padding: 10px;
      background: #0f3460;
      margin-bottom: 10px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      background: #f39c12;
      color: #1a1a2e;
      border-radius: 8px;
      font-weight: bold;
      display: none;
      z-index: 2000;
      animation: slideIn 0.3s;
    }
    
    .toast.show {
      display: block;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
      }
      to {
        transform: translateX(0);
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div id="app"><!-- Welcome Screen -->
   <div id="welcome" class="screen active welcome-screen">
    <h1 id="gameTitle">üîê Escape Room: Grammaire Fran√ßaise</h1>
    <p id="welcomeMessage">Vous √™tes enferm√© dans une salle myst√©rieuse ! Pour vous √©chapper, vous devez trouver 6 chiffres du code secret en interagissant avec les objets de 5 salles diff√©rentes. Chaque objet cache une activit√© de grammaire fran√ßaise niveau B1. R√©solvez les 30 activit√©s et d√©verrouillez la sortie !</p><input type="text" id="studentName" class="name-input" placeholder="Entrez votre nom" maxlength="50"> <button class="btn" onclick="startGame()">Commencer l'aventure</button>
   </div><!-- Game Screen with Room Visual -->
   <div id="game" class="screen">
    <div class="room-container">
     <div class="room-header">
      <h2 class="room-title" id="roomTitle">Salle 1: Les Temps</h2>
      <p class="room-description" id="roomDescription">Explorez la salle et cliquez sur les objets pour d√©couvrir les activit√©s cach√©es</p>
      <div class="progress-info">
       <div class="clues-found" id="cluesFound">
        Indices: 0/6
       </div>
       <div class="timer" id="timer">
        Temps: 0:00
       </div>
      </div>
     </div>
     <div class="room-visual">
      <div class="room-scene" id="roomScene"><!-- Objects will be added dynamically -->
      </div>
      <div class="code-panel">
       <div class="code-label">
        CODE SECRET
       </div>
       <div class="code-display" id="codeDisplay">
        _ _ _ _ _ _
       </div><button class="btn unlock-btn" id="unlockBtn" onclick="attemptEscape()" style="display:none;">üîì D√©verrouiller la porte</button>
      </div>
     </div>
    </div>
   </div><!-- Activity Modal -->
   <div id="activityModal" class="modal-overlay">
    <div class="modal-content"><button class="modal-close" onclick="closeModal()">√ó</button>
     <h3 class="activity-title" id="activityTitle">Activit√©</h3>
     <div id="activityContainer"></div><button class="btn submit-btn" id="submitBtn" onclick="submitAnswer()">Valider</button>
    </div>
   </div><!-- Completion Screen -->
   <div id="completion" class="screen completion-screen">
    <h2 id="successMessage">üéâ F√©licitations ! Vous vous √™tes √©chapp√© !</h2>
    <div class="score-display">
     Score: <span id="finalScore">0</span>/30
    </div>
    <div>
     <p>Temps total: <span id="finalTime">0:00</span></p>
    </div>
    <div class="leaderboard">
     <h3>üèÜ Tableau des scores</h3>
     <div id="leaderboardList"></div>
    </div><button class="btn" onclick="resetGame()">Rejouer</button>
   </div>
   <div id="toast" class="toast"></div>
  </div>
  <script>
    const defaultConfig = {
      game_title: "üîê Escape Room: Grammaire Fran√ßaise",
      welcome_message: "Bienvenue dans l'escape room de grammaire fran√ßaise niveau B1 ! R√©solvez 30 questions r√©parties en 5 salles th√©matiques. Utilisez vos comp√©tences en glisser-d√©poser, d√©couvrez des indices cach√©s et cliquez sur les bons √©l√©ments pour vous √©chapper !",
      success_message: "üéâ F√©licitations ! Vous vous √™tes √©chapp√© !",
      background_color: "#1a1a2e",
      surface_color: "#16213e",
      text_color: "#eeeeee",
      primary_action_color: "#f39c12",
      secondary_action_color: "#27ae60"
    };

    const roomObjects = [
      // Salle 1: Les Temps
      { room: 1, icon: 'üï∞Ô∏è', label: 'Horloge', position: { top: '15%', left: '20%' } },
      { room: 1, icon: 'üìÖ', label: 'Calendrier', position: { top: '20%', right: '15%' } },
      { room: 1, icon: '‚è≥', label: 'Sablier', position: { top: '50%', left: '10%' } },
      { room: 1, icon: 'üìñ', label: 'Journal', position: { top: '60%', right: '20%' } },
      { room: 1, icon: '‚åö', label: 'Montre', position: { bottom: '15%', left: '25%' } },
      { room: 1, icon: 'üîî', label: 'Cloche', position: { bottom: '20%', right: '30%' } },
      
      // Salle 2: Les Pronoms
      { room: 2, icon: 'üë§', label: 'Portrait', position: { top: '10%', left: '15%' } },
      { room: 2, icon: 'ü™û', label: 'Miroir', position: { top: '15%', right: '20%' } },
      { room: 2, icon: 'üë•', label: 'Photos', position: { top: '45%', left: '12%' } },
      { room: 2, icon: 'üíº', label: 'Valise', position: { top: '55%', right: '18%' } },
      { room: 2, icon: 'üìß', label: 'Lettre', position: { bottom: '18%', left: '22%' } },
      { room: 2, icon: 'üì±', label: 'T√©l√©phone', position: { bottom: '15%', right: '25%' } },
      
      // Salle 3: Le Subjonctif
      { room: 3, icon: 'üé≠', label: 'Masque', position: { top: '12%', left: '18%' } },
      { room: 3, icon: 'üí≠', label: 'Nuage', position: { top: '18%', right: '15%' } },
      { room: 3, icon: 'üé®', label: 'Palette', position: { top: '48%', left: '15%' } },
      { room: 3, icon: 'üé™', label: 'Chapiteau', position: { top: '52%', right: '22%' } },
      { room: 3, icon: 'üéØ', label: 'Cible', position: { bottom: '20%', left: '20%' } },
      { room: 3, icon: 'üîÆ', label: 'Boule', position: { bottom: '18%', right: '28%' } },
      
      // Salle 4: Les Pr√©positions
      { room: 4, icon: 'üó∫Ô∏è', label: 'Carte', position: { top: '15%', left: '22%' } },
      { room: 4, icon: 'üß≠', label: 'Boussole', position: { top: '20%', right: '18%' } },
      { room: 4, icon: 'üåç', label: 'Globe', position: { top: '50%', left: '14%' } },
      { room: 4, icon: '‚úàÔ∏è', label: 'Avion', position: { top: '48%', right: '20%' } },
      { room: 4, icon: 'üèõÔ∏è', label: 'Monument', position: { bottom: '22%', left: '25%' } },
      { room: 4, icon: 'üéí', label: 'Sac', position: { bottom: '18%', right: '22%' } },
      
      // Salle 5: Les Connecteurs
      { room: 5, icon: 'üîó', label: 'Cha√Æne', position: { top: '18%', left: '20%' } },
      { room: 5, icon: 'üß©', label: 'Puzzle', position: { top: '22%', right: '16%' } },
      { room: 5, icon: 'üåâ', label: 'Pont', position: { top: '52%', left: '16%' } },
      { room: 5, icon: 'üîÄ', label: 'Fl√®ches', position: { top: '48%', right: '24%' } },
      { room: 5, icon: '‚ö°', label: '√âclair', position: { bottom: '20%', left: '28%' } },
      { room: 5, icon: 'üîë', label: 'Cl√© finale', position: { bottom: '25%', right: '20%' } }
    ];

    const questions = [
      // Salle 1: Les temps (6 questions)
      {
        room: 1,
        objectIndex: 0,
        type: 'multiple',
        text: 'Compl√©tez: "Hier, je ___ au cin√©ma avec mes amis."',
        options: ['vais', 'suis all√©', 'irai', 'allais'],
        correct: 1,
        codeDigit: '7'
      },
      {
        room: 1,
        objectIndex: 1,
        type: 'drag-drop',
        text: 'Classez ces verbes selon leur temps:',
        items: ['mangeais', 'ai mang√©', 'mangerai', 'mange'],
        zones: ['Pr√©sent', 'Pass√© compos√©', 'Imparfait', 'Futur'],
        correct: {'mange': 'Pr√©sent', 'ai mang√©': 'Pass√© compos√©', 'mangeais': 'Imparfait', 'mangerai': 'Futur'},
        codeDigit: '3'
      },
      {
        room: 1,
        objectIndex: 2,
        type: 'clickable',
        text: 'Cliquez sur tous les verbes √† l\'imparfait:',
        options: ['je parlais', 'tu as parl√©', 'il parlera', 'nous parlions', 'vous parlez', 'ils parlaient'],
        correct: [0, 3, 5],
        codeDigit: '9'
      },
      {
        room: 1,
        objectIndex: 3,
        type: 'multiple',
        text: 'Quel temps exprime une action habituelle dans le pass√©?',
        options: ['Le pass√© compos√©', 'L\'imparfait', 'Le futur simple', 'Le pr√©sent'],
        correct: 1,
        codeDigit: '2'
      },
      {
        room: 1,
        objectIndex: 4,
        type: 'hidden',
        text: 'Trouvez l\'indice cach√© pour compl√©ter: "Demain, nous ___ √† Paris."',
        clue: 'üí° Cliquez ici pour r√©v  ler l\'indice',
        clueText: 'Indice: Utilisez le futur simple du verbe "aller"',
        options: ['allons', 'sommes all√©s', 'irons', 'allions'],
        correct: 2,
        codeDigit: '5'
      },
      {
        room: 1,
        objectIndex: 5,
        type: 'multiple',
        text: 'Compl√©tez: "Quand j\'√©tais petit, je ___ beaucoup de bonbons."',
        options: ['mange', 'ai mang√©', 'mangeais', 'mangerai'],
        correct: 2,
        codeDigit: '1'
      },
      
      // Salle 2: Les pronoms (6 questions)
      {
        room: 2,
        objectIndex: 0,
        type: 'multiple',
        text: 'Remplacez "Marie" par le pronom correct: "Je vois Marie."',
        options: ['le', 'la', 'les', 'lui'],
        correct: 1,
        codeDigit: '4'
      },
      {
        room: 2,
        objectIndex: 1,
        type: 'drag-drop',
        text: 'Associez les pronoms √† leur fonction:',
        items: ['me', 'te', 'lui', 'nous'],
        zones: ['COD 1√®re pers.', 'COD 2√®me pers.', 'COI 3√®me pers.', 'COD 1√®re pers. pl.'],
        correct: {'me': 'COD 1√®re pers.', 'te': 'COD 2√®me pers.', 'lui': 'COI 3√®me pers.', 'nous': 'COD 1√®re pers. pl.'},
        codeDigit: '8'
      },
      {
        room: 2,
        objectIndex: 2,
        type: 'clickable',
        text: 'Cliquez sur les pronoms COI (compl√©ment d\'objet indirect):',
        options: ['le', 'lui', 'les', 'leur', 'la', 'nous'],
        correct: [1, 3],
        codeDigit: '6'
      },
      {
        room: 2,
        objectIndex: 3,
        type: 'multiple',
        text: 'Compl√©tez: "Tu ___ t√©l√©phones souvent?" (√† tes parents)',
        options: ['les', 'leur', 'lui', 'eux'],
        correct: 1,
        codeDigit: '2'
      },
      {
        room: 2,
        objectIndex: 4,
        type: 'hidden',
        text: 'R√©v√©lez l\'indice: "Je donne le livre √† Pierre." ‚Üí "Je ___ donne."',
        clue: 'üí° Cliquez pour l\'indice',
        clueText: 'Indice: Pierre est un COI masculin singulier',
        options: ['le', 'la', 'lui', 'leur'],
        correct: 2,
        codeDigit: '7'
      },
      {
        room: 2,
        objectIndex: 5,
        type: 'multiple',
        text: 'Quel pronom remplace "√† nous"?',
        options: ['vous', 'nous', 'leur', 'les'],
        correct: 1,
        codeDigit: '3'
      },
      
      // Salle 3: Le subjonctif (6 questions)
      {
        room: 3,
        objectIndex: 0,
        type: 'multiple',
        text: 'Compl√©tez: "Il faut que tu ___ tes devoirs."',
        options: ['fais', 'fasses', 'fait', 'faire'],
        correct: 1,
        codeDigit: '5'
      },
      {
        room: 3,
        objectIndex: 1,
        type: 'clickable',
        text: 'Cliquez sur les expressions qui demandent le subjonctif:',
        options: ['il faut que', 'je pense que', 'je veux que', 'je sais que', 'il est important que', 'je crois que'],
        correct: [0, 2, 4],
        codeDigit: '1'
      },
      {
        room: 3,
        objectIndex: 2,
        type: 'drag-drop',
        text: 'Associez les verbes au subjonctif correct:',
        items: ['avoir', '√™tre', 'faire', 'aller'],
        zones: ['aie', 'sois', 'fasse', 'aille'],
        correct: {'avoir': 'aie', '√™tre': 'sois', 'faire': 'fasse', 'aller': 'aille'},
        codeDigit: '9'
      },
      {
        room: 3,
        objectIndex: 3,
        type: 'multiple',
        text: 'Compl√©tez: "Je doute qu\'il ___ venir demain."',
        options: ['peut', 'puisse', 'pourra', 'pouvait'],
        correct: 1,
        codeDigit: '4'
      },
      {
        room: 3,
        objectIndex: 4,
        type: 'hidden',
        text: 'Trouvez la bonne forme: "Bien que nous ___ fatigu√©s..."',
        clue: 'üí° Indice cach√© ici',
        clueText: 'Indice: "Bien que" demande le subjonctif du verbe "√™tre"',
        options: ['sommes', 'soyons', '√©tions', 'serons'],
        correct: 1,
        codeDigit: '6'
      },
      {
        room: 3,
        objectIndex: 5,
        type: 'multiple',
        text: 'Quelle phrase utilise correctement le subjonctif?',
        options: [
          'Je pense qu\'il vient.',
          'Je veux qu\'il vienne.',
          'Je sais qu\'il vient.',
          'Je crois qu\'il vient.'
        ],
        correct: 1,
        codeDigit: '8'
      },
      
      // Salle 4: Les pr√©positions (6 questions)
      {
        room: 4,
        objectIndex: 0,
        type: 'multiple',
        text: 'Compl√©tez: "Je vais ___ France cet √©t√©."',
        options: ['√†', 'en', 'au', 'aux'],
        correct: 1,
        codeDigit: '3'
      },
      {
        room: 4,
        objectIndex: 1,
        type: 'drag-drop',
        text: 'Associez les pays √† la bonne pr√©position:',
        items: ['France', '√âtats-Unis', 'Japon', 'Pays-Bas'],
        zones: ['en', 'aux', 'au', 'aux'],
        correct: {'France': 'en', '√âtats-Unis': 'aux', 'Japon': 'au', 'Pays-Bas': 'aux'},
        codeDigit: '2'
      },
      {
        room: 4,
        objectIndex: 2,
        type: 'clickable',
        text: 'Cliquez sur les pr√©positions de lieu:',
        options: ['dans', 'pour', 'sur', 'avec', 'sous', 'pendant'],
        correct: [0, 2, 4],
        codeDigit: '7'
      },
      {
        room: 4,
        objectIndex: 3,
        type: 'multiple',
        text: 'Compl√©tez: "J\'habite ___ Lyon depuis 5 ans."',
        options: ['√†', 'en', 'dans', 'au'],
        correct: 0,
        codeDigit: '1'
      },
      {
        room: 4,
        objectIndex: 4,
        type: 'hidden',
        text: 'Indice cach√©: "Le livre est ___ la table."',
        clue: 'üí° R√©v√©lez l\'indice',
        clueText: 'Indice: L\'objet est au-dessus de la surface',
        options: ['dans', 'sous', 'sur', 'entre'],
        correct: 2,
        codeDigit: '5'
      },
      {
        room: 4,
        objectIndex: 5,
        type: 'multiple',
        text: 'Quelle pr√©position utilise-t-on avec "penser"?',
        options: ['penser de', 'penser √†', 'penser pour', 'penser avec'],
        correct: 1,
        codeDigit: '4'
      },
      
      // Salle 5: Les connecteurs et structures (6 questions)
      {
        room: 5,
        objectIndex: 0,
        type: 'multiple',
        text: 'Compl√©tez: "___ il pleuve, nous irons au parc."',
        options: ['Parce que', 'Bien que', 'Si', 'Quand'],
        correct: 1,
        codeDigit: '9'
      },
      {
        room: 5,
        objectIndex: 1,
        type: 'drag-drop',
        text: 'Classez ces connecteurs selon leur fonction:',
        items: ['donc', 'mais', 'parce que', 'ensuite'],
        zones: ['Cons√©quence', 'Opposition', 'Cause', 'Temps'],
        correct: {'donc': 'Cons√©quence', 'mais': 'Opposition', 'parce que': 'Cause', 'ensuite': 'Temps'},
        codeDigit: '6'
      },
      {
        room: 5,
        objectIndex: 2,
        type: 'clickable',
        text: 'Cliquez sur les connecteurs de cause:',
        options: ['car', 'donc', 'parce que', 'alors', 'puisque', 'mais'],
        correct: [0, 2, 4],
        codeDigit: '3'
      },
      {
        room: 5,
        objectIndex: 3,
        type: 'multiple',
        text: 'Compl√©tez: "Il ne vient pas ___ il est malade."',
        options: ['donc', 'car', 'mais', 'alors'],
        correct: 1,
        codeDigit: '8'
      },
      {
        room: 5,
        objectIndex: 4,
        type: 'hidden',
        text: 'Indice: Trouvez le bon connecteur: "J\'aime le caf√© ___ je pr√©f√®re le th√©."',
        clue: 'üí° Cliquez pour l\'indice',
        clueText: 'Indice: On exprime une opposition/pr√©f√©rence',
        options: ['et', 'donc', 'mais', 'car'],
        correct: 2,
        codeDigit: '2'
      },
      {
        room: 5,
        objectIndex: 5,
        type: 'multiple',
        text: 'Quel connecteur exprime la cons√©quence?',
        options: ['parce que', 'bien que', 'donc', 'si'],
        correct: 2,
        codeDigit: '7'
      }
    ];

    let gameState = {
      studentName: '',
      currentRoom: 1,
      completedObjects: [],
      secretCode: [],
      score: 0,
      startTime: 0,
      currentActivity: null,
      currentAnswer: null,
      draggedItems: {}
    };

    let timerInterval;
    let allCompletions = [];

    const dataHandler = {
      onDataChanged(data) {
        allCompletions = data;
        if (document.getElementById('completion').classList.contains('active')) {
          renderLeaderboard();
        }
      }
    };

    async function initializeApp() {
      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          console.error('Failed to initialize data SDK');
        }
      }

      if (window.elementSdk) {
        await window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            const customFont = config.font_family || defaultConfig.font_family;
            const baseFontStack = 'Georgia, serif';
            const baseSize = config.font_size || 16;

            document.body.style.fontFamily = `${customFont}, ${baseFontStack}`;
            document.body.style.background = config.background_color || defaultConfig.background_color;
            document.body.style.color = config.text_color || defaultConfig.text_color;

            const allText = document.querySelectorAll('h1, h2, h3, p, button, input, .option, .draggable, .clickable-element');
            allText.forEach(el => {
              el.style.fontFamily = `${customFont}, ${baseFontStack}`;
            });

            document.querySelectorAll('h1').forEach(el => {
              el.style.fontSize = `${baseSize * 3}px`;
            });
            document.querySelectorAll('h2, .room-title').forEach(el => {
              el.style.fontSize = `${baseSize * 2}px`;
            });
            document.querySelectorAll('p, .question-text').forEach(el => {
              el.style.fontSize = `${baseSize * 1.25}px`;
            });
            document.querySelectorAll('button, .option, input').forEach(el => {
              el.style.fontSize = `${baseSize * 1.125}px`;
            });

            document.querySelectorAll('.question-card, .drop-zone, .draggables-container, .hidden-clue, .leaderboard').forEach(el => {
              el.style.background = config.surface_color || defaultConfig.surface_color;
            });

            document.querySelectorAll('.btn, .draggable, .progress-fill').forEach(el => {
              el.style.background = config.primary_action_color || defaultConfig.primary_action_color;
            });

            document.querySelectorAll('.room-title, .drop-zone-label, .clue-hint').forEach(el => {
              el.style.color = config.primary_action_color || defaultConfig.primary_action_color;
            });

            document.getElementById('gameTitle').textContent = config.game_title || defaultConfig.game_title;
            document.getElementById('welcomeMessage').textContent = config.welcome_message || defaultConfig.welcome_message;
            document.getElementById('successMessage').textContent = config.success_message || defaultConfig.success_message;
          },
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.background_color || defaultConfig.background_color,
                set: (value) => {
                  if (window.elementSdk) {
                    window.elementSdk.setConfig({ background_color: value });
                  }
                }
              },
              {
                get: () => config.surface_color || defaultConfig.surface_color,
                set: (value) => {
                  if (window.elementSdk) {
                    window.elementSdk.setConfig({ surface_color: value });
                  }
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  if (window.elementSdk) {
                    window.elementSdk.setConfig({ text_color: value });
                  }
                }
              },
              {
                get: () => config.primary_action_color || defaultConfig.primary_action_color,
                set: (value) => {
                  if (window.elementSdk) {
                    window.elementSdk.setConfig({ primary_action_color: value });
                  }
                }
              },
              {
                get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
                set: (value) => {
                  if (window.elementSdk) {
                    window.elementSdk.setConfig({ secondary_action_color: value });
                  }
                }
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => config.font_family || defaultConfig.font_family,
              set: (value) => {
                if (window.elementSdk) {
                  window.elementSdk.setConfig({ font_family: value });
                }
              }
            },
            fontSizeable: {
              get: () => config.font_size || defaultConfig.font_size,
              set: (value) => {
                if (window.elementSdk) {
                  window.elementSdk.setConfig({ font_size: value });
                }
              }
            }
          }),
          mapToEditPanelValues: (config) => new Map([
            ['game_title', config.game_title || defaultConfig.game_title],
            ['welcome_message', config.welcome_message || defaultConfig.welcome_message],
            ['success_message', config.success_message || defaultConfig.success_message]
          ])
        });
      }
    }

    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function startGame() {
      const name = document.getElementById('studentName').value.trim();
      if (!name) {
        showToast('Veuillez entrer votre nom');
        return;
      }
      
      gameState.studentName = name;
      gameState.currentRoom = 1;
      gameState.completedObjects = [];
      gameState.secretCode = [];
      gameState.score = 0;
      gameState.startTime = Date.now();
      
      showScreen('game');
      startTimer();
      renderRoom();
    }

    function renderRoom() {
      const roomNames = ['Les Temps', 'Les Pronoms', 'Le Subjonctif', 'Les Pr√©positions', 'Les Connecteurs'];
      const roomDescriptions = [
        'Explorez la salle et cliquez sur les objets pour d√©couvrir les activit√©s cach√©es',
        'Interagissez avec les objets pour trouver les indices du code',
        'Chaque objet contient une activit√© de grammaire',
        'R√©solvez les √©nigmes cach√©es dans les objets',
        'Trouvez le dernier chiffre du code secret'
      ];
      
      document.getElementById('roomTitle').textContent = `Salle ${gameState.currentRoom}: ${roomNames[gameState.currentRoom - 1]}`;
      document.getElementById('roomDescription').textContent = roomDescriptions[gameState.currentRoom - 1];
      
      const scene = document.getElementById('roomScene');
      scene.innerHTML = '';
      
      const roomObjs = roomObjects.filter(obj => obj.room === gameState.currentRoom);
      roomObjs.forEach((obj, index) => {
        const objElement = document.createElement('div');
        objElement.className = 'room-object';
        
        const globalIndex = roomObjects.findIndex(o => o === obj);
        const isCompleted = gameState.completedObjects.includes(globalIndex);
        
        if (isCompleted) {
          objElement.classList.add('completed');
        }
        
        Object.keys(obj.position).forEach(key => {
          objElement.style[key] = obj.position[key];
        });
        
        objElement.innerHTML = `
          <span class="object-icon">${obj.icon}</span>
          <span class="object-label">${obj.label}</span>
        `;
        
        objElement.onclick = () => openObject(globalIndex);
        scene.appendChild(objElement);
      });
      
      updateCodeDisplay();
    }

    function updateCodeDisplay() {
      const codeArray = new Array(6).fill('_');
      gameState.secretCode.forEach((digit, index) => {
        codeArray[index] = digit;
      });
      document.getElementById('codeDisplay').textContent = codeArray.join(' ');
      document.getElementById('cluesFound').textContent = `Indices: ${gameState.secretCode.length}/6`;
      
      if (gameState.secretCode.length === 6) {
        document.getElementById('unlockBtn').style.display = 'block';
      }
    }

    function openObject(objectIndex) {
      if (gameState.completedObjects.includes(objectIndex)) {
        showToast('Vous avez d√©j√† compl√©t√© cette activit√© !');
        return;
      }
      
      const question = questions.find(q => 
        q.room === gameState.currentRoom && q.objectIndex === roomObjects[objectIndex].icon.indexOf(roomObjects[objectIndex].icon)
      );
      
      const questionIndex = questions.findIndex(q => 
        q.room === gameState.currentRoom && 
        roomObjects.filter(o => o.room === q.room).findIndex(o => o === roomObjects[objectIndex]) === q.objectIndex
      );
      
      if (questionIndex === -1) return;
      
      gameState.currentActivity = questionIndex;
      gameState.currentAnswer = null;
      gameState.draggedItems = {};
      
      loadActivity(questions[questionIndex]);
      document.getElementById('activityModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('activityModal').classList.remove('active');
      gameState.currentActivity = null;
    }

    function startTimer() {
      timerInterval = setInterval(() => {
        const elapsed = Date.now() - gameState.startTime;
        const minutes = Math.floor(elapsed / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        document.getElementById('timer').textContent = `Temps: ${minutes}:${seconds.toString().padStart(2, '0')}`;
      }, 1000);
    }

    function loadActivity(q) {
      const container = document.getElementById('activityContainer');
      document.getElementById('activityTitle').textContent = roomObjects.find((o, i) => 
        o.room === q.room && questions.filter(qu => qu.room === q.room).indexOf(q) === q.objectIndex
      )?.label || 'Activit√©';
      
      gameState.currentAnswer = null;
      gameState.draggedItems = {};
      
      let html = `<div class="question-text">${q.text}</div>`;
      
      if (q.type === 'multiple') {
        html += '<div class="options">';
        q.options.forEach((opt, i) => {
          html += `<div class="option" onclick="selectOption(${i})">${opt}</div>`;
        });
        html += '</div>';
      } else if (q.type === 'drag-drop') {
        html += '<div class="draggables-container" id="draggables">';
        q.items.forEach((item, i) => {
          html += `<div class="draggable" draggable="true" data-item="${item}" data-index="${i}">${item}</div>`;
        });
        html += '</div><div class="drag-drop-area">';
        q.zones.forEach((zone, i) => {
          html += `<div class="drop-zone" data-zone="${zone}">
            <div class="drop-zone-label">${zone}</div>
          </div>`;
        });
        html += '</div>';
      } else if (q.type === 'clickable') {
        html += '<div class="options">';
        q.options.forEach((opt, i) => {
          html += `<div class="clickable-element" onclick="toggleClickable(${i})">${opt}</div>`;
        });
        html += '</div>';
      } else if (q.type === 'hidden') {
        html += `<div class="hidden-clue" onclick="revealClue()">
          <div class="clue-hint">${q.clue}</div>
          <div class="clue-content" id="clueContent">${q.clueText}</div>
        </div>`;
        html += '<div class="options">';
        q.options.forEach((opt, i) => {
          html += `<div class="option" onclick="selectOption(${i})">${opt}</div>`;
        });
        html += '</div>';
      }
      
      html += '<div class="feedback" id="feedback"></div>';
      container.innerHTML = html;
      
      if (q.type === 'drag-drop') {
        setupDragAndDrop();
      }
    }

    function setupDragAndDrop() {
      const draggables = document.querySelectorAll('.draggable');
      const dropZones = document.querySelectorAll('.drop-zone');
      
      draggables.forEach(draggable => {
        draggable.addEventListener('dragstart', (e) => {
          draggable.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/html', draggable.innerHTML);
          e.dataTransfer.setData('item', draggable.dataset.item);
        });
        
        draggable.addEventListener('dragend', () => {
          draggable.classList.remove('dragging');
        });
      });
      
      dropZones.forEach(zone => {
        zone.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
        });
        
        zone.addEventListener('drop', (e) => {
          e.preventDefault();
          const item = e.dataTransfer.getData('item');
          const zoneName = zone.dataset.zone;
          const dragging = document.querySelector('.dragging');
          
          if (dragging) {
            // Remove from old zone if exists
            Object.keys(gameState.draggedItems).forEach(key => {
              if (gameState.draggedItems[key] === zoneName) {
                delete gameState.draggedItems[key];
              }
            });
            
            gameState.draggedItems[item] = zoneName;
            zone.appendChild(dragging);
          }
        });
      });
      
      // Allow dropping back to original container
      const draggablesContainer = document.getElementById('draggables');
      if (draggablesContainer) {
        draggablesContainer.addEventListener('dragover', (e) => {
          e.preventDefault();
        });
        
        draggablesContainer.addEventListener('drop', (e) => {
          e.preventDefault();
          const dragging = document.querySelector('.dragging');
          if (dragging) {
            const item = dragging.dataset.item;
            delete gameState.draggedItems[item];
            draggablesContainer.appendChild(dragging);
          }
        });
      }
    }

    function selectOption(index) {
      document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
      document.querySelectorAll('.option')[index].classList.add('selected');
      gameState.currentAnswer = index;
    }

    function toggleClickable(index) {
      const elements = document.querySelectorAll('.clickable-element');
      elements[index].classList.toggle('clicked');
      
      if (!gameState.currentAnswer) {
        gameState.currentAnswer = [];
      }
      const idx = gameState.currentAnswer.indexOf(index);
      if (idx > -1) {
        gameState.currentAnswer.splice(idx, 1);
      } else {
        gameState.currentAnswer.push(index);
      }
    }

    function revealClue() {
      document.getElementById('clueContent').classList.add('revealed');
      showToast('Indice r√©v√©l√©!');
    }

    function submitAnswer() {
      if (gameState.currentActivity === null) return;
      
      const q = questions[gameState.currentActivity];
      let isCorrect = false;
      
      if (q.type === 'multiple' || q.type === 'hidden') {
        isCorrect = gameState.currentAnswer === q.correct;
      } else if (q.type === 'drag-drop') {
        isCorrect = Object.keys(q.correct).every(key => 
          gameState.draggedItems[key] === q.correct[key]
        ) && Object.keys(gameState.draggedItems).length === Object.keys(q.correct).length;
      } else if (q.type === 'clickable') {
        if (gameState.currentAnswer && gameState.currentAnswer.length === q.correct.length) {
          isCorrect = q.correct.every(idx => gameState.currentAnswer.includes(idx));
        }
      }
      
      const feedback = document.getElementById('feedback');
      feedback.classList.add('show');
      
      if (isCorrect) {
        gameState.score++;
        feedback.textContent = `‚úì Correct ! Vous avez trouv√© le chiffre: ${q.codeDigit}`;
        feedback.classList.add('correct');
        feedback.classList.remove('incorrect');
        
        const objectIndex = roomObjects.findIndex((obj, i) => 
          obj.room === q.room && 
          roomObjects.filter(o => o.room === q.room).indexOf(obj) === q.objectIndex
        );
        
        if (!gameState.completedObjects.includes(objectIndex)) {
          gameState.completedObjects.push(objectIndex);
          gameState.secretCode.push(q.codeDigit);
        }
        
        setTimeout(() => {
          closeModal();
          renderRoom();
          
          const roomQuestions = questions.filter(qu => qu.room === gameState.currentRoom);
          const roomCompleted = roomQuestions.every((qu, i) => {
            const objIdx = roomObjects.findIndex((obj, idx) => 
              obj.room === qu.room && 
              roomObjects.filter(o => o.room === qu.room).indexOf(obj) === qu.objectIndex
            );
            return gameState.completedObjects.includes(objIdx);
          });
          
          if (roomCompleted && gameState.currentRoom < 5) {
            setTimeout(() => {
              showToast(`Salle ${gameState.currentRoom} termin√©e ! Passage √† la salle suivante...`);
              gameState.currentRoom++;
              renderRoom();
            }, 500);
          }
        }, 1500);
      } else {
        feedback.textContent = '‚úó Incorrect. R√©essayez !';
        feedback.classList.add('incorrect');
        feedback.classList.remove('correct');
        
        setTimeout(() => {
          feedback.classList.remove('show');
        }, 2000);
      }
    }

    function attemptEscape() {
      if (gameState.score < 30) {
        showToast('Vous devez compl√©ter les 30 activit√©s avant de vous √©chapper !');
        return;
      }
      
      if (gameState.secretCode.length === 6) {
        endGame();
      }
    }

    async function endGame() {
      clearInterval(timerInterval);
      
      const elapsed = Date.now() - gameState.startTime;
      const minutes = Math.floor(elapsed / 60000);
      const seconds = Math.floor((elapsed % 60000) / 1000);
      const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      document.getElementById('finalScore').textContent = gameState.score;
      document.getElementById('finalTime').textContent = timeString;
      
      showScreen('completion');
      
      if (window.dataSdk && allCompletions.length < 999) {
        const submitBtn = document.querySelector('.btn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Enregistrement...';
        
        const result = await window.dataSdk.create({
          student_name: gameState.studentName,
          current_room: 5,
          score: gameState.score,
          completed_at: new Date().toISOString(),
          time_taken: elapsed
        });
        
        submitBtn.disabled = false;
        
        if (result.isOk) {
          showToast('Score enregistr√©!');
        } else {
          showToast('Erreur lors de l\'enregistrement');
        }
      } else if (allCompletions.length >= 999) {
        showToast('Limite de 999 entr√©es atteinte');
      }
    }

    function renderLeaderboard() {
      const list = document.getElementById('leaderboardList');
      
      if (allCompletions.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #888;">Aucun score enregistr√©</p>';
        return;
      }
      
      const sorted = [...allCompletions].sort((a, b) => {
        if (b.score !== a.score) return b.score - a.score;
        return a.time_taken - b.time_taken;
      }).slice(0, 10);
      
      list.innerHTML = sorted.map((entry, i) => {
        const minutes = Math.floor(entry.time_taken / 60000);
        const seconds = Math.floor((entry.time_taken % 60000) / 1000);
        const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        return `<div class="leaderboard-entry">
          <span>${i + 1}. ${entry.student_name}</span>
          <span>${entry.score}/30 - ${timeStr}</span>
        </div>`;
      }).join('');
    }

    function resetGame() {
      gameState = {
        studentName: '',
        currentRoom: 1,
        completedObjects: [],
        secretCode: [],
        score: 0,
        startTime: 0,
        currentActivity: null,
        currentAnswer: null,
        draggedItems: {}
      };
      
      document.getElementById('studentName').value = '';
      document.getElementById('unlockBtn').style.display = 'none';
      showScreen('welcome');
    }

    initializeApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a0e8535279175ad',t:'MTc2MzU0Mjg1OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>